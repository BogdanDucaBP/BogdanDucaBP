<html>
<head>
    <title>Test Reports</title>
</head>
<body>
    <h1>Welcome to Test Reports</h1>
    <div id="reports-container">
        <p>Loading test reports...</p>
    </div>

    <script>
async function fetchReportsFromGitHub() {
    const repoOwner = "BogdanDucaBP";  // Replace with your GitHub username or org
    const repoName = "BogdanDucaBP";   // Replace with your repository name
    const reportsPath = "reports";     // The folder containing reports
    const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${reportsPath}`;

    const reportsContainer = document.getElementById('reports-container');
    reportsContainer.innerHTML = '';

    try {
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

        const files = await response.json();
        const xmlFiles = files.filter(file => 
            file.name.endsWith('.xml') && !file.name.includes('_junit') // Ignore invalid files
        );

        let totalPassed = 0;
        let totalFailed = 0;

        for (const file of xmlFiles) {
            const fileUrl = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/main/${reportsPath}/${file.name}`;

            try {
                const fileResponse = await fetch(fileUrl);
                if (!fileResponse.ok) throw new Error(`HTTP error! Status: ${fileResponse.status}`);

                const xmlText = await fileResponse.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

                // Get counts of passed and failed tests
                const [passed, failed] = displayXml(xmlDoc, file.name, reportsContainer);

                totalPassed += passed;
                totalFailed += failed;
            } catch (fileError) {
                console.error(`Error fetching ${file.name}:`, fileError);
            }
        }

        // Display the total count of passed and failed tests
        const reportStats = document.getElementById('report-stats');
        reportStats.innerHTML = `Total Passed: ${totalPassed} | Total Failed: ${totalFailed}`;
    } catch (error) {
        console.error("Error fetching reports list:", error);
        reportsContainer.innerHTML = `<p>Error fetching reports list: ${error.message}</p>`;
    }
}

function displayXml(xmlDoc, headingText, reportsContainer) {
    console.log("displayXml called with:", xmlDoc, headingText);

    let passedCount = 0;
    let failedCount = 0;

    const testSuites = xmlDoc.querySelectorAll('testsuite');

    if (testSuites.length > 0) {
        const reportHeading = document.createElement('h2');
        reportHeading.textContent = headingText;
        reportsContainer.appendChild(reportHeading);
    }

    testSuites.forEach(suite => {
        const suiteName = suite.getAttribute('name');

        if (suiteName) {  // Only show if suite has a name
            const suiteElement = document.createElement('p');
            suiteElement.textContent = `Test Suite: ${suiteName}`;
            reportsContainer.appendChild(suiteElement);
        }

        const testCases = suite.querySelectorAll('testcase');
        testCases.forEach(testCase => {
            const caseName = testCase.getAttribute('name');
            const caseElement = document.createElement('p');
            
            // Check if the test case has a failure
            const failure = testCase.querySelector('failure');
            if (failure) {
                caseElement.textContent = `❌ ${caseName} - FAILED`;
                caseElement.style.color = "red"; // Red for failed tests
                const failureMessage = document.createElement('p');
                failureMessage.textContent = `  - Reason: ${failure.textContent}`;
                failureMessage.style.fontStyle = "italic";
                reportsContainer.appendChild(caseElement);
                reportsContainer.appendChild(failureMessage);

                failedCount++; // Increment failed count
            } else {
                caseElement.textContent = `✅ ${caseName} - PASSED`;
                caseElement.style.color = "green"; // Green for passed tests
                reportsContainer.appendChild(caseElement);

                passedCount++; // Increment passed count
            }
        });
    });

    return [passedCount, failedCount]; // Return counts
}

fetchReportsFromGitHub();
</script>

</body>
</html>
