<html>
<head>
    <title>Test Reports</title>
</head>
<body>
    <h1>Welcome to Test Reports</h1>
    <div id="reports-container">
        <p>Loading test reports...</p>
    </div>

    <script>
        async function displayReports() {
            const reportsContainer = document.getElementById('reports-container');
            reportsContainer.innerHTML = ''; // Clear loading message

            try {
                // Fetch the list of subdirectories within 'reports/'
                const reportsDirResponse = await fetch('reports/');
                const reportsDirText = await reportsDirResponse.text();

                // Extract directory names from the HTML listing
                const dirNames = [];
                const parser = new DOMParser();
                const reportsDirDoc = parser.parseFromString(reportsDirText, 'text/html');
                const links = reportsDirDoc.querySelectorAll('a');
                links.forEach(link => {
                    const href = link.getAttribute('href');
                    if (href.endsWith('/') && href != "./") { //prevent adding the ./ to the list.
                        dirNames.push(href.slice(0, -1)); // Remove trailing slash
                    }
                });

                for (const dirName of dirNames) {
                    try {
                        // Fetch the directory's content to find the XML file
                        const dirContentResponse = await fetch(`reports/${dirName}/`);
                        const dirContentText = await dirContentResponse.text();
                        const dirContentDoc = parser.parseFromString(dirContentText, 'text/html');
                        const xmlLinks = dirContentDoc.querySelectorAll('a');

                        let xmlFileName = null;
                        xmlLinks.forEach(link => {
                            const href = link.getAttribute('href');
                            if (href.endsWith('.xml')) {
                                xmlFileName = href;
                            }
                        });

                        if (xmlFileName) {
                            const response = await fetch(`reports/${dirName}/${xmlFileName}`);
                            const xmlText = await response.text();
                            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

                            // Extract and display the relevant information from the XML
                            const testSuites = xmlDoc.querySelectorAll('testsuite');
                            if(testSuites.length > 0){
                                const reportHeading = document.createElement('h2');
                                reportHeading.textContent = dirName;
                                reportsContainer.appendChild(reportHeading);
                            }

                            testSuites.forEach(suite => {
                                const suiteName = suite.getAttribute('name');
                                const suiteElement = document.createElement('p');
                                suiteElement.textContent = `Test Suite: ${suiteName}`;
                                reportsContainer.appendChild(suiteElement);

                                const testCases = suite.querySelectorAll('testcase');
                                testCases.forEach(testCase => {
                                    const caseName = testCase.getAttribute('name');
                                    const caseElement = document.createElement('p');
                                    caseElement.textContent = `  - Test Case: ${caseName}`;
                                    reportsContainer.appendChild(caseElement);
                                });
                            });
                        }
                    } catch (dirError) {
                        console.error(`Error loading directory ${dirName}:`, dirError);
                        reportsContainer.innerHTML += `<p>Error loading directory ${dirName}.</p>`;
                    }
                }

                //Handle files directly in the reports folder.
                await handleReportsFiles(reportsContainer); //Call the async function.

            } catch (reportsError) {
                console.error('Error loading reports directory:', reportsError);
                reportsContainer.innerHTML = '<p>Error loading test reports.</p>';
            }
        }

        async function handleReportsFiles(reportsContainer){ //Create the async function.
            try {
                const reportsContentResponse = await fetch(`reports/`);
                const reportsContentText = await reportsContentResponse.text();
                const reportsContentDoc = parser.parseFromString(reportsContentText, 'text/html');
                const xmlLinksReports = reportsContentDoc.querySelectorAll('a');

                xmlLinksReports.forEach(link=>{
                    const href = link.getAttribute('href');
                    if (href.endsWith('.xml')){
                        const response = await fetch(`reports/${href}`);
                        const xmlText = await response.text();
                        const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

                        const testSuites = xmlDoc.querySelectorAll('testsuite');
                        if(testSuites.length > 0){
                            const reportHeading = document.createElement('h2');
                            reportHeading.textContent = href;
                            reportsContainer.appendChild(reportHeading);
                        }

                        testSuites.forEach(suite => {
                            const suiteName = suite.getAttribute('name');
                            const suiteElement = document.createElement('p');
                            suiteElement.textContent = `Test Suite: ${suiteName}`;
                            reportsContainer.appendChild(suiteElement);

                            const testCases = suite.querySelectorAll('testcase');
                            testCases.forEach(testCase => {
                                const caseName = testCase.getAttribute('name');
                                const caseElement = document.createElement('p');
                                caseElement.textContent = `  - Test Case: ${caseName}`;
                                reportsContainer.appendChild(caseElement);
                            });
                        }
                    })
                }
            }catch(e){
                console.error("Error loading reports directory files", e);
                reportsContainer.innerHTML += `<p>Error loading reports directory files.</p>`;
            }
        }

        displayReports();
    </script>
</body>
</html>
